<%- include('./partials/header') %>

<div class="w-full min-h-screen flex flex-col px-20 py-20 gap-10">
    <% if (typeof error !== 'undefined' && error.length > 0) { %>
        <div class="relative w-full text-center font-sans text-red-500">
            <div class="absolute top-5 left-1/2 transform -translate-x-1/2 p-4 rounded-md bg-red-500 text-white shadow-lg">
                <span class="inline-block mt-1 mb-1"><%= error[0] %></span>
                <button onclick="this.parentElement.style.display='none'" class="absolute top-2 right-2 text-white hover:text-gray-200">&times;</button>
            </div>
            <h2 class="text-2xl mt-10">An error occurred: <%= error[0] %></h2>
            <a href="/shop" class="mt-5 inline-block px-4 py-2 bg-blue-500 text-white rounded">Return to Shop</a>
        </div>
    <% } else if (validProducts && validProducts.length > 0) { %>
        <div class="flex w-full gap-8 font-[Lato]">
            <!-- Cart Items Section -->
            <div class="w-1/3 bg-white rounded-md shadow-lg p-5 space-y-6">
                <h3 class="text-lg font-bold">Your Cart</h3>
                <% validProducts.forEach(function(cart) { %>
                    <% if (cart && cart._id) { %>
                        <div class="w-full mb-6 border border-gray-300 rounded-lg shadow-lg overflow-hidden">
                            <div class="w-full h-80 flex items-center justify-center bg-[<%= cart.bgcolor %>]">
                                <img class="h-[20rem]" src="data:image/jpeg;base64, <%= cart.image ? cart.image.toString('base64') : '' %>" alt="<%= cart.name %>">
                            </div>
                            <div class="w-full flex justify-between px-5 py-4 bg-[<%= cart.bgcolor %>]">
                                <h3 class="text-2xl text-[<%= cart.textcolor %>]"><%= cart.name %></h3>
                                <div class="flex items-center gap-2">
                                    <a href="/cart?action=increase&productId=<%= cart._id %>" class="w-7 h-7 bg-white flex rounded-full items-center justify-center hover:bg-gray-200">
                                        <i class="ri-add-line font-sans"></i>
                                    </a>
                                    <div class="px-3 py-1 rounded-md bg-white text-black"><%= cart.quantity %></div>
                                    <a href="/cart?action=decrease&productId=<%= cart._id %>" class="w-7 h-7 bg-white flex rounded-full items-center justify-center hover:bg-gray-200">
                                        <i class="ri-subtract-line"></i>
                                    </a>
                                </div>
                            </div>
                            <div class="flex items-center justify-between px-5 py-3 bg-[<%= cart.pannelcolor %>]">
                                <h4 class="text-lg text-[<%= cart.textcolor %>]">Net Total</h4>
                                <h2 class="text-lg text-[<%= cart.textcolor %>]">₹ <%= (cart.price - cart.discount) * cart.quantity %></h2>
                                <a href="/removefromcart/<%= cart._id %>" class="text-[<%= cart.textcolor %>] hover:text-red-600">
                                    <i class="ri-delete-bin-6-line"></i>
                                </a>
                            </div>
                        </div>
                    <% } %>
                <% }); %>
            </div>

            <!-- Price Breakdown Section -->
            <div class="w-2/3 bg-white rounded-md shadow-lg p-5">
                <h3 class="text-xl font-semibold">Price Breakdown</h3>
                <div class="mt-5 space-y-4">
                    <% 
                        let totalMRP = validProducts.reduce((sum, cart) => sum + cart.price * cart.quantity, 0);
                        let totalDiscount = validProducts.reduce((sum, cart) => sum + cart.discount * cart.quantity, 0);
                        let platformFee = 20; // Assuming a fixed platform fee
                        let totalAmount = totalMRP - totalDiscount + platformFee;
                    %>
                    <div class="flex justify-between">
                        <h4 class="text-lg">Total MRP</h4>
                        <h4 class="text-lg">₹ <%= totalMRP %></h4>
                    </div>
                    <div class="flex justify-between">
                        <h4 class="text-lg">Discount on MRP</h4>
                        <h4 class="text-lg">₹ <%= totalDiscount %></h4>
                    </div>
                    <div class="flex justify-between">
                        <h4 class="text-lg">Platform Fee</h4>
                        <h4 class="text-lg">₹ <%= platformFee %></h4>
                    </div>
                    <div class="flex justify-between">
                        <h4 class="text-lg">Shipping Fee</h4>
                        <h4 class="text-lg text-green-600">FREE</h4>
                    </div>
                </div>

                <div class="border-t border-gray-300 mt-8"></div>

                <div class="flex justify-between items-center mt-5">
                    <h3 class="text-xl font-semibold">Total Amount</h3>
                    <h3 class="text-xl font-bold text-green-600">₹ <%= totalAmount %></h3>
                </div>

                <form action="<%= serverUrl %>/checkout" method="POST" class="mt-5">
                    <button id="razorpay-checkout-btn" type="submit" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-all">Proceed to Checkout</button>
                </form>                
            </div>
        </div>
    <% } else { %>
        <div class="w-full text-center font-sans">
            <h2 class="text-2xl">Your cart is empty</h2>
            <a href="/shop" class="mt-5 inline-block px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-all">Continue Shopping</a>
        </div>
    <% } %>
</div>

<%- include('./partials/footer') %>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<!--checkout script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkoutBtn = document.getElementById('razorpay-checkout-btn');
        if (checkoutBtn) {
            checkoutBtn.onclick = async function(e) {
                e.preventDefault();
                
                try {
                    const response = await fetch('/checkout/create-order', { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to create order');
                    }
                    
                    const data = await response.json();
                    
                    const options = {
                        key: data.keyId,
                        amount: data.amount,
                        currency: data.currency,
                        name: "Your Store Name",
                        description: "Purchase Description",
                        order_id: data.orderId,
                        handler: async function (response) {
                            try {
                                const result = await fetch('/checkout/payment-success', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(response)
                                });
                                
                                if (!result.ok) {
                                    throw new Error('Payment verification failed');
                                }
                                
                                const verificationData = await result.json();
                                
                                if (verificationData.success) {
                                    alert('Payment Successful!');
                                    window.location.href = '/order-confirmation';
                                } else {
                                    alert('Payment Failed. Please try again.');
                                }
                            } catch (error) {
                                console.error('Payment verification error:', error);
                                alert('An error occurred while verifying the payment. Please contact support.');
                            }
                        },
                        prefill: {
                            name: "<%= locals.user ? user.name : '' %>",
                            email: "<%= locals.user ? user.email : '' %>",
                            contact: "<%= locals.user ? user.phone : '' %>"
                        },
                        theme: {
                            color: "#3399cc"
                        }
                    };
                    
                    const rzp1 = new Razorpay(options);
                    rzp1.open();
                    
                } catch (error) {
                    console.error('Checkout error:', error);
                    alert('An error occurred during checkout. Please try again later.');
                }
            };
        }
    });
    </script>